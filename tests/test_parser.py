"""
Tests for the HTML parsing functions in module.html_parser."""

import pathlib

import pytest

from module.html_parser import _parse_i, _parse_l, parser
from utils.encryption import decrypt_data

CWD = pathlib.Path(__file__).parent


def test_parser():
    url = "https://google.com"
    data = parser(url=url)

    assert isinstance(data, dict)
    assert data["url"] == url
    assert data["job_posting_company"] is None
    assert data["job_title"] is None
    assert data["job_description"] is None


def test_parse_l():
    with open(CWD / "01KGYJVAE492GXPAQASFXVQSQ3.html", "rb") as f:
        encrypted_data = f.read()

    decrypted_url = decrypt_data(
        b'~l\xd0Ts[O\xec\xa8\x1c\xb2\x83\x1f\x12\xaa\xc4\xf7\xc5B\xbd\x03\xc6\xf0\xabLg\x16\xc1@\x07\xa6\xe4\x9a\xc6_L\xbdo\xd8\xad5\t\x1c\x93\xad\xc8\xe7\xad\xfa\x81\xe6\x052\xdb\x98\xa1\x10\xb1\xd9\xd8gd\xb8"!M\\\nT\xa9\xc2\xc8?$JS|\xfe\x00\x0c\xa9\x953~\xafPy\xb2 \xed\xe5U\xdf\x9aZ\x86D\xf8~~\x953\xc7\xc9[\xf0\xc6\xd5\xdcb*\xe1\xee\x00\xba\x9e\xd2\xc3\xd6\xb4r\x90];E[\xd0|7\xe3\xd1\x01\x13m<\x8d%\xe6\xbf2\x07\xdc\x98\xaf_\xb7\x06b\x10\xc1\xfd\xaf5\xec\n \xa3\x18\xbe\x96\xb1H\x03\xd7\xbeb\x95V3\x8b\xd7\xfd)\x8ac\xe9\xde\xaa\xd3\xab\xc9\x19\xf4{Q\xcfo\xd9\x0e\x98o\xba}\x1a\x91\x11:\x96\x14\xcai\xd8\x0c}\xef7k\x88c\xe3na=\x83\xb5\xfa\xa4\xda\x87\xf3f\xc6\xc1\xf7\xc6\x80@\x12O%\xda\xd0\xd8\r\xef\xe1"\x04\\\x9c7I\xb7\xc3\xd5\xb4!\xa0\x96\xd8\x18\x910\xb2J9'
    )
    decrypted_data = decrypt_data(encrypted_data)

    result = _parse_l(
        url=decrypted_url,
        response_text=decrypted_data,
    )

    assert isinstance(result, dict)
    assert result["url"] == decrypted_url
    assert result["job_posting_company"] == "Bugatti Rimac"
    assert result["job_title"] == "Data Engineer"
    assert result["job_description"] is not None


def test_parse_i():
    with open(CWD / "01KGYJVAE4FA9Q162N2ECXXNPP.html", "rb") as f:
        encrypted_data = f.read()

    decrypted_url = decrypt_data(
        b'$\x90\xc0\xe3\xa9k\xef\xee\xcd\x87<\xeeF\xf6RaAd\x93\xd6\xa4\xce`\x9d\x14\xcf\xbb4\xa0\xed?\xdb\xa1\x0b\xe1\t\x96\x89u\x83\x9ep\x8a\xb7\xb08@\xe7N\\\x957\x15\x9e\x12\xd1\xb6j\xd9\xd28\x88\xd0ck\xb1S\xd5\x18\xbav\x13]\xb1\xa8b\xb0\xf24H\xf2\xb7cy\xbeJr\xf7\x9c\xcb\x01\xc4N\x98\x82K\xac\xdc\xaf@i\xb0\x87\n\xe6\x1e\xbfS\x1f\x82\x80G\xe1,\x88\xce\x95\x9f\x08\xf1F^\xb2\x83\xde6/\xfd\xfe@m\xb1\x06L\x19\xd59Y\xb8\x82\x88R\xfb\x08\x1a\xc1\x07\xbb\xcc\x98\xc54K\xa0\x1bQ\xf8>v`\nr\x0b@!\x013\xf7\x16\xc3\xd9\x93\xb3\x0eQz_\xc8\t\xc1t\xf1]*\xce\xa3P\xe6\xa6\x86\xaa\n\x92\x17\x7fK\xfd\xfbKp\x0c\xc8\x17\x9e\xe3\xdfs\xc5A\xccy\x8d\x19\xf1\x97m\x05\x15\x1f\xb6\xcc\x04-\xf7\x8d\xf4\xf3x\xa6\x05\xd6\xa1h\x88n-\x0f\xa8H\xbbm(\x93\xfe\xe7\xe2H\x8d_\x01\t\x02\x1d"\x85\xd5'
    )
    decrypted_data = decrypt_data(encrypted_data)

    result = _parse_i(
        url=decrypted_url,
        response_text=decrypted_data,
    )

    assert isinstance(result, dict)
    assert result["url"] == decrypted_url
    assert result["job_posting_company"] == "Apple"
    assert result["job_title"] == "Data Engineer"
    assert result["job_description"] is not None
